
define("tinymce/FocusManager",["tinymce/dom/DOMUtils","tinymce/Env"],function(DOMUtils,Env){var selectionChangeHandler,documentFocusInHandler,documentMouseUpHandler,DOM=DOMUtils.DOM;function FocusManager(editorManager){function getActiveElement(){try{return document.activeElement;}catch(ex){return document.body;}}
function createBookmark(dom,rng){if(rng&&rng.startContainer){if(!dom.isChildOf(rng.startContainer,dom.getRoot())||!dom.isChildOf(rng.endContainer,dom.getRoot())){return;}
return{startContainer:rng.startContainer,startOffset:rng.startOffset,endContainer:rng.endContainer,endOffset:rng.endOffset};}
return rng;}
function bookmarkToRng(editor,bookmark){var rng;if(bookmark.startContainer){rng=editor.getDoc().createRange();rng.setStart(bookmark.startContainer,bookmark.startOffset);rng.setEnd(bookmark.endContainer,bookmark.endOffset);}else{rng=bookmark;}
return rng;}
function isUIElement(elm){return!!DOM.getParent(elm,FocusManager.isEditorUIElement);}
function registerEvents(e){var editor=e.editor;editor.on('init',function(){if(editor.inline||Env.ie){if("onbeforedeactivate"in document&&Env.ie<9){editor.dom.bind(editor.getBody(),'beforedeactivate',function(e){if(e.target!=editor.getBody()){return;}
try{editor.lastRng=editor.selection.getRng();}catch(ex){}});}else{editor.on('nodechange mouseup keyup',function(e){var node=getActiveElement();if(e.type=='nodechange'&&e.selectionChange){return;}
if(node&&node.id==editor.id+'_ifr'){node=editor.getBody();}
if(editor.dom.isChildOf(node,editor.getBody())){editor.lastRng=editor.selection.getRng();}});}
if(Env.webkit&&!selectionChangeHandler){selectionChangeHandler=function(){var activeEditor=editorManager.activeEditor;if(activeEditor&&activeEditor.selection){var rng=activeEditor.selection.getRng();if(rng&&!rng.collapsed){editor.lastRng=rng;}}};DOM.bind(document,'selectionchange',selectionChangeHandler);}}});editor.on('setcontent',function(){editor.lastRng=null;});editor.on('mousedown',function(){editor.selection.lastFocusBookmark=null;});editor.on('focusin',function(){var focusedEditor=editorManager.focusedEditor;if(editor.selection.lastFocusBookmark){editor.selection.setRng(bookmarkToRng(editor,editor.selection.lastFocusBookmark));editor.selection.lastFocusBookmark=null;}
if(focusedEditor!=editor){if(focusedEditor){focusedEditor.fire('blur',{focusedEditor:editor});}
editorManager.setActive(editor);editorManager.focusedEditor=editor;editor.fire('focus',{blurredEditor:focusedEditor});editor.focus(true);}
editor.lastRng=null;});editor.on('focusout',function(){window.setTimeout(function(){var focusedEditor=editorManager.focusedEditor;if(!isUIElement(getActiveElement())&&focusedEditor==editor){editor.fire('blur',{focusedEditor:null});editorManager.focusedEditor=null;if(editor.selection){editor.selection.lastFocusBookmark=null;}}},0);});if(!documentFocusInHandler){documentFocusInHandler=function(e){var activeEditor=editorManager.activeEditor;if(activeEditor&&e.target.ownerDocument==document){if(activeEditor.selection&&e.target!=activeEditor.getBody()){activeEditor.selection.lastFocusBookmark=createBookmark(activeEditor.dom,activeEditor.lastRng);}
if(e.target!=document.body&&!isUIElement(e.target)&&editorManager.focusedEditor==activeEditor){activeEditor.fire('blur',{focusedEditor:null});editorManager.focusedEditor=null;}}};DOM.bind(document,'focusin',documentFocusInHandler);}
if(editor.inline&&!documentMouseUpHandler){documentMouseUpHandler=function(e){var activeEditor=editorManager.activeEditor;if(activeEditor.inline&&!activeEditor.dom.isChildOf(e.target,activeEditor.getBody())){var rng=activeEditor.selection.getRng();if(!rng.collapsed){activeEditor.lastRng=rng;}}};DOM.bind(document,'mouseup',documentMouseUpHandler);}}
function unregisterDocumentEvents(e){if(editorManager.focusedEditor==e.editor){editorManager.focusedEditor=null;}
if(!editorManager.activeEditor){DOM.unbind(document,'selectionchange',selectionChangeHandler);DOM.unbind(document,'focusin',documentFocusInHandler);DOM.unbind(document,'mouseup',documentMouseUpHandler);selectionChangeHandler=documentFocusInHandler=documentMouseUpHandler=null;}}
editorManager.on('AddEditor',registerEvents);editorManager.on('RemoveEditor',unregisterDocumentEvents);}
FocusManager.isEditorUIElement=function(elm){return elm.className.toString().indexOf('mce-')!==-1;};return FocusManager;});