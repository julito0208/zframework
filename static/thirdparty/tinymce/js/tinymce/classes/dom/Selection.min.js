
define("tinymce/dom/Selection",["tinymce/dom/TreeWalker","tinymce/dom/TridentSelection","tinymce/dom/ControlSelection","tinymce/dom/RangeUtils","tinymce/dom/BookmarkManager","tinymce/Env","tinymce/util/Tools"],function(TreeWalker,TridentSelection,ControlSelection,RangeUtils,BookmarkManager,Env,Tools){var each=Tools.each,trim=Tools.trim;var isIE=Env.ie;function Selection(dom,win,serializer,editor){var self=this;self.dom=dom;self.win=win;self.serializer=serializer;self.editor=editor;self.bookmarkManager=new BookmarkManager(self);self.controlSelection=new ControlSelection(self,editor);if(!self.win.getSelection){self.tridentSel=new TridentSelection(self);}}
Selection.prototype={setCursorLocation:function(node,offset){var self=this,rng=self.dom.createRng();if(!node){self._moveEndPoint(rng,self.editor.getBody(),true);self.setRng(rng);}else{rng.setStart(node,offset);rng.setEnd(node,offset);self.setRng(rng);self.collapse(false);}},getContent:function(args){var self=this,rng=self.getRng(),tmpElm=self.dom.create("body");var se=self.getSel(),whiteSpaceBefore,whiteSpaceAfter,fragment;args=args||{};whiteSpaceBefore=whiteSpaceAfter='';args.get=true;args.format=args.format||'html';args.selection=true;self.editor.fire('BeforeGetContent',args);if(args.format=='text'){return self.isCollapsed()?'':(rng.text||(se.toString?se.toString():''));}
if(rng.cloneContents){fragment=rng.cloneContents();if(fragment){tmpElm.appendChild(fragment);}}else if(rng.item!==undefined||rng.htmlText!==undefined){tmpElm.innerHTML='<br>'+(rng.item?rng.item(0).outerHTML:rng.htmlText);tmpElm.removeChild(tmpElm.firstChild);}else{tmpElm.innerHTML=rng.toString();}
if(/^\s/.test(tmpElm.innerHTML)){whiteSpaceBefore=' ';}
if(/\s+$/.test(tmpElm.innerHTML)){whiteSpaceAfter=' ';}
args.getInner=true;args.content=self.isCollapsed()?'':whiteSpaceBefore+self.serializer.serialize(tmpElm,args)+whiteSpaceAfter;self.editor.fire('GetContent',args);return args.content;},setContent:function(content,args){var self=this,rng=self.getRng(),caretNode,doc=self.win.document,frag,temp;args=args||{format:'html'};args.set=true;args.selection=true;content=args.content=content;if(!args.no_events){self.editor.fire('BeforeSetContent',args);}
content=args.content;if(rng.insertNode){content+='<span id="__caret">_</span>';if(rng.startContainer==doc&&rng.endContainer==doc){doc.body.innerHTML=content;}else{rng.deleteContents();if(doc.body.childNodes.length===0){doc.body.innerHTML=content;}else{if(rng.createContextualFragment){rng.insertNode(rng.createContextualFragment(content));}else{frag=doc.createDocumentFragment();temp=doc.createElement('div');frag.appendChild(temp);temp.outerHTML=content;rng.insertNode(frag);}}}
caretNode=self.dom.get('__caret');rng=doc.createRange();rng.setStartBefore(caretNode);rng.setEndBefore(caretNode);self.setRng(rng);self.dom.remove('__caret');try{self.setRng(rng);}catch(ex){}}else{if(rng.item){doc.execCommand('Delete',false,null);rng=self.getRng();}
if(/^\s+/.test(content)){rng.pasteHTML('<span id="__mce_tmp">_</span>'+content);self.dom.remove('__mce_tmp');}else{rng.pasteHTML(content);}}
if(!args.no_events){self.editor.fire('SetContent',args);}},getStart:function(real){var self=this,rng=self.getRng(),startElement,parentElement,checkRng,node;if(rng.duplicate||rng.item){if(rng.item){return rng.item(0);}
checkRng=rng.duplicate();checkRng.collapse(1);startElement=checkRng.parentElement();if(startElement.ownerDocument!==self.dom.doc){startElement=self.dom.getRoot();}
parentElement=node=rng.parentElement();while((node=node.parentNode)){if(node==startElement){startElement=parentElement;break;}}
return startElement;}else{startElement=rng.startContainer;if(startElement.nodeType==1&&startElement.hasChildNodes()){if(!real||!rng.collapsed){startElement=startElement.childNodes[Math.min(startElement.childNodes.length-1,rng.startOffset)];}}
if(startElement&&startElement.nodeType==3){return startElement.parentNode;}
return startElement;}},getEnd:function(real){var self=this,rng=self.getRng(),endElement,endOffset;if(rng.duplicate||rng.item){if(rng.item){return rng.item(0);}
rng=rng.duplicate();rng.collapse(0);endElement=rng.parentElement();if(endElement.ownerDocument!==self.dom.doc){endElement=self.dom.getRoot();}
if(endElement&&endElement.nodeName=='BODY'){return endElement.lastChild||endElement;}
return endElement;}else{endElement=rng.endContainer;endOffset=rng.endOffset;if(endElement.nodeType==1&&endElement.hasChildNodes()){if(!real||!rng.collapsed){endElement=endElement.childNodes[endOffset>0?endOffset-1:endOffset];}}
if(endElement&&endElement.nodeType==3){return endElement.parentNode;}
return endElement;}},getBookmark:function(type,normalized){return this.bookmarkManager.getBookmark(type,normalized);},moveToBookmark:function(bookmark){return this.bookmarkManager.moveToBookmark(bookmark);},select:function(node,content){var self=this,dom=self.dom,rng=dom.createRng(),idx;self.lastFocusBookmark=null;if(node){if(!content&&self.controlSelection.controlSelect(node)){return;}
idx=dom.nodeIndex(node);rng.setStart(node.parentNode,idx);rng.setEnd(node.parentNode,idx+1);if(content){self._moveEndPoint(rng,node,true);self._moveEndPoint(rng,node);}
self.setRng(rng);}
return node;},isCollapsed:function(){var self=this,rng=self.getRng(),sel=self.getSel();if(!rng||rng.item){return false;}
if(rng.compareEndPoints){return rng.compareEndPoints('StartToEnd',rng)===0;}
return!sel||rng.collapsed;},collapse:function(toStart){var self=this,rng=self.getRng(),node;if(rng.item){node=rng.item(0);rng=self.win.document.body.createTextRange();rng.moveToElementText(node);}
rng.collapse(!!toStart);self.setRng(rng);},getSel:function(){var win=this.win;return win.getSelection?win.getSelection():win.document.selection;},getRng:function(w3c){var self=this,selection,rng,elm,doc=self.win.document,ieRng;function tryCompareBoundaryPoints(how,sourceRange,destinationRange){try{return sourceRange.compareBoundaryPoints(how,destinationRange);}catch(ex){return-1;}}
if(!w3c&&self.lastFocusBookmark){var bookmark=self.lastFocusBookmark;if(bookmark.startContainer){rng=doc.createRange();rng.setStart(bookmark.startContainer,bookmark.startOffset);rng.setEnd(bookmark.endContainer,bookmark.endOffset);}else{rng=bookmark;}
return rng;}
if(w3c&&self.tridentSel){return self.tridentSel.getRangeAt(0);}
try{if((selection=self.getSel())){if(selection.rangeCount>0){rng=selection.getRangeAt(0);}else{rng=selection.createRange?selection.createRange():doc.createRange();}}}catch(ex){}
if(isIE&&rng&&rng.setStart&&doc.selection){try{ieRng=doc.selection.createRange();}catch(ex){}
if(ieRng&&ieRng.item){elm=ieRng.item(0);rng=doc.createRange();rng.setStartBefore(elm);rng.setEndAfter(elm);}}
if(!rng){rng=doc.createRange?doc.createRange():doc.body.createTextRange();}
if(rng.setStart&&rng.startContainer.nodeType===9&&rng.collapsed){elm=self.dom.getRoot();rng.setStart(elm,0);rng.setEnd(elm,0);}
if(self.selectedRange&&self.explicitRange){if(tryCompareBoundaryPoints(rng.START_TO_START,rng,self.selectedRange)===0&&tryCompareBoundaryPoints(rng.END_TO_END,rng,self.selectedRange)===0){rng=self.explicitRange;}else{self.selectedRange=null;self.explicitRange=null;}}
return rng;},setRng:function(rng,forward){var self=this,sel;if(rng.select){try{rng.select();}catch(ex){}
return;}
if(!self.tridentSel){sel=self.getSel();if(sel){self.explicitRange=rng;try{sel.removeAllRanges();sel.addRange(rng);}catch(ex){}
if(forward===false&&sel.extend){sel.collapse(rng.endContainer,rng.endOffset);sel.extend(rng.startContainer,rng.startOffset);}
self.selectedRange=sel.rangeCount>0?sel.getRangeAt(0):null;}}else{if(rng.cloneRange){try{self.tridentSel.addRange(rng);return;}catch(ex){}}}},setNode:function(elm){var self=this;self.setContent(self.dom.getOuterHTML(elm));return elm;},getNode:function(){var self=this,rng=self.getRng(),elm;var startContainer=rng.startContainer,endContainer=rng.endContainer;var startOffset=rng.startOffset,endOffset=rng.endOffset,root=self.dom.getRoot();function skipEmptyTextNodes(node,forwards){var orig=node;while(node&&node.nodeType===3&&node.length===0){node=forwards?node.nextSibling:node.previousSibling;}
return node||orig;}
if(!rng){return root;}
if(rng.setStart){elm=rng.commonAncestorContainer;if(!rng.collapsed){if(startContainer==endContainer){if(endOffset-startOffset<2){if(startContainer.hasChildNodes()){elm=startContainer.childNodes[startOffset];}}}
if(startContainer.nodeType===3&&endContainer.nodeType===3){if(startContainer.length===startOffset){startContainer=skipEmptyTextNodes(startContainer.nextSibling,true);}else{startContainer=startContainer.parentNode;}
if(endOffset===0){endContainer=skipEmptyTextNodes(endContainer.previousSibling,false);}else{endContainer=endContainer.parentNode;}
if(startContainer&&startContainer===endContainer){return startContainer;}}}
if(elm&&elm.nodeType==3){return elm.parentNode;}
return elm;}
elm=rng.item?rng.item(0):rng.parentElement();if(elm.ownerDocument!==self.win.document){elm=root;}
return elm;},getSelectedBlocks:function(startElm,endElm){var self=this,dom=self.dom,node,root,selectedBlocks=[];root=dom.getRoot();startElm=dom.getParent(startElm||self.getStart(),dom.isBlock);endElm=dom.getParent(endElm||self.getEnd(),dom.isBlock);if(startElm&&startElm!=root){selectedBlocks.push(startElm);}
if(startElm&&endElm&&startElm!=endElm){node=startElm;var walker=new TreeWalker(startElm,root);while((node=walker.next())&&node!=endElm){if(dom.isBlock(node)){selectedBlocks.push(node);}}}
if(endElm&&startElm!=endElm&&endElm!=root){selectedBlocks.push(endElm);}
return selectedBlocks;},isForward:function(){var dom=this.dom,sel=this.getSel(),anchorRange,focusRange;if(!sel||!sel.anchorNode||!sel.focusNode){return true;}
anchorRange=dom.createRng();anchorRange.setStart(sel.anchorNode,sel.anchorOffset);anchorRange.collapse(true);focusRange=dom.createRng();focusRange.setStart(sel.focusNode,sel.focusOffset);focusRange.collapse(true);return anchorRange.compareBoundaryPoints(anchorRange.START_TO_START,focusRange)<=0;},normalize:function(){var self=this,rng=self.getRng();if(!isIE&&new RangeUtils(self.dom).normalize(rng)){self.setRng(rng,self.isForward());}
return rng;},selectorChanged:function(selector,callback){var self=this,currentSelectors;if(!self.selectorChangedData){self.selectorChangedData={};currentSelectors={};self.editor.on('NodeChange',function(e){var node=e.element,dom=self.dom,parents=dom.getParents(node,null,dom.getRoot()),matchedSelectors={};each(self.selectorChangedData,function(callbacks,selector){each(parents,function(node){if(dom.is(node,selector)){if(!currentSelectors[selector]){each(callbacks,function(callback){callback(true,{node:node,selector:selector,parents:parents});});currentSelectors[selector]=callbacks;}
matchedSelectors[selector]=callbacks;return false;}});});each(currentSelectors,function(callbacks,selector){if(!matchedSelectors[selector]){delete currentSelectors[selector];each(callbacks,function(callback){callback(false,{node:node,selector:selector,parents:parents});});}});});}
if(!self.selectorChangedData[selector]){self.selectorChangedData[selector]=[];}
self.selectorChangedData[selector].push(callback);return self;},getScrollContainer:function(){var scrollContainer,node=this.dom.getRoot();while(node&&node.nodeName!='BODY'){if(node.scrollHeight>node.clientHeight){scrollContainer=node;break;}
node=node.parentNode;}
return scrollContainer;},scrollIntoView:function(elm){var y,viewPort,self=this,dom=self.dom,root=dom.getRoot(),viewPortY,viewPortH;function getPos(elm){var x=0,y=0;var offsetParent=elm;while(offsetParent&&offsetParent.nodeType){x+=offsetParent.offsetLeft||0;y+=offsetParent.offsetTop||0;offsetParent=offsetParent.offsetParent;}
return{x:x,y:y};}
if(root.nodeName!='BODY'){var scrollContainer=self.getScrollContainer();if(scrollContainer){y=getPos(elm).y-getPos(scrollContainer).y;viewPortH=scrollContainer.clientHeight;viewPortY=scrollContainer.scrollTop;if(y<viewPortY||y+25>viewPortY+viewPortH){scrollContainer.scrollTop=y<viewPortY?y:y-viewPortH+25;}
return;}}
viewPort=dom.getViewPort(self.editor.getWin());y=dom.getPos(elm).y;viewPortY=viewPort.y;viewPortH=viewPort.h;if(y<viewPort.y||y+25>viewPortY+viewPortH){self.editor.getWin().scrollTo(0,y<viewPortY?y:y-viewPortH+25);}},placeCaretAt:function(clientX,clientY){var doc=this.editor.getDoc(),rng,point;if(doc.caretPositionFromPoint){point=doc.caretPositionFromPoint(clientX,clientY);rng=doc.createRange();rng.setStart(point.offsetNode,point.offset);rng.collapse(true);}else if(doc.caretRangeFromPoint){rng=doc.caretRangeFromPoint(clientX,clientY);}else if(doc.body.createTextRange){rng=doc.body.createTextRange();try{rng.moveToPoint(clientX,clientY);rng.collapse(true);}catch(ex){rng.collapse(clientY<doc.body.clientHeight);}}
this.setRng(rng);},_moveEndPoint:function(rng,node,start){var root=node,walker=new TreeWalker(node,root);var nonEmptyElementsMap=this.dom.schema.getNonEmptyElements();do{if(node.nodeType==3&&trim(node.nodeValue).length!==0){if(start){rng.setStart(node,0);}else{rng.setEnd(node,node.nodeValue.length);}
return;}
if(nonEmptyElementsMap[node.nodeName]&&!/^(TD|TH)$/.test(node.nodeName)){if(start){rng.setStartBefore(node);}else{if(node.nodeName=='BR'){rng.setEndBefore(node);}else{rng.setEndAfter(node);}}
return;}
if(Env.ie&&Env.ie<11&&this.dom.isBlock(node)&&this.dom.isEmpty(node)){if(start){rng.setStart(node,0);}else{rng.setEnd(node,0);}
return;}}while((node=(start?walker.next():walker.prev())));if(root.nodeName=='BODY'){if(start){rng.setStart(root,0);}else{rng.setEnd(root,root.childNodes.length);}}},destroy:function(){this.win=null;this.controlSelection.destroy();}};return Selection;});