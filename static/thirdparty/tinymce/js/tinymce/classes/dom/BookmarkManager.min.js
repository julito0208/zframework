
define("tinymce/dom/BookmarkManager",["tinymce/Env","tinymce/util/Tools"],function(Env,Tools){function BookmarkManager(selection){var dom=selection.dom;this.getBookmark=function(type,normalized){var rng,rng2,id,collapsed,name,element,chr='&#xFEFF;',styles;function findIndex(name,element){var index=0;Tools.each(dom.select(name),function(node,i){if(node==element){index=i;}});return index;}
function normalizeTableCellSelection(rng){function moveEndPoint(start){var container,offset,childNodes,prefix=start?'start':'end';container=rng[prefix+'Container'];offset=rng[prefix+'Offset'];if(container.nodeType==1&&container.nodeName=="TR"){childNodes=container.childNodes;container=childNodes[Math.min(start?offset:offset-1,childNodes.length-1)];if(container){offset=start?0:container.childNodes.length;rng['set'+(start?'Start':'End')](container,offset);}}}
moveEndPoint(true);moveEndPoint();return rng;}
function getLocation(){var rng=selection.getRng(true),root=dom.getRoot(),bookmark={};function getPoint(rng,start){var container=rng[start?'startContainer':'endContainer'],offset=rng[start?'startOffset':'endOffset'],point=[],node,childNodes,after=0;if(container.nodeType==3){if(normalized){for(node=container.previousSibling;node&&node.nodeType==3;node=node.previousSibling){offset+=node.nodeValue.length;}}
point.push(offset);}else{childNodes=container.childNodes;if(offset>=childNodes.length&&childNodes.length){after=1;offset=Math.max(0,childNodes.length-1);}
point.push(dom.nodeIndex(childNodes[offset],normalized)+after);}
for(;container&&container!=root;container=container.parentNode){point.push(dom.nodeIndex(container,normalized));}
return point;}
bookmark.start=getPoint(rng,true);if(!selection.isCollapsed()){bookmark.end=getPoint(rng);}
return bookmark;}
if(type==2){element=selection.getNode();name=element?element.nodeName:null;if(name=='IMG'){return{name:name,index:findIndex(name,element)};}
if(selection.tridentSel){return selection.tridentSel.getBookmark(type);}
return getLocation();}
if(type){return{rng:selection.getRng()};}
rng=selection.getRng();id=dom.uniqueId();collapsed=selection.isCollapsed();styles='overflow:hidden;line-height:0px';if(rng.duplicate||rng.item){if(!rng.item){rng2=rng.duplicate();try{rng.collapse();rng.pasteHTML('<span data-mce-type="bookmark" id="'+id+'_start" style="'+styles+'">'+chr+'</span>');if(!collapsed){rng2.collapse(false);rng.moveToElementText(rng2.parentElement());if(rng.compareEndPoints('StartToEnd',rng2)===0){rng2.move('character',-1);}
rng2.pasteHTML('<span data-mce-type="bookmark" id="'+id+'_end" style="'+styles+'">'+chr+'</span>');}}catch(ex){return null;}}else{element=rng.item(0);name=element.nodeName;return{name:name,index:findIndex(name,element)};}}else{element=selection.getNode();name=element.nodeName;if(name=='IMG'){return{name:name,index:findIndex(name,element)};}
rng2=normalizeTableCellSelection(rng.cloneRange());if(!collapsed){rng2.collapse(false);rng2.insertNode(dom.create('span',{'data-mce-type':"bookmark",id:id+'_end',style:styles},chr));}
rng=normalizeTableCellSelection(rng);rng.collapse(true);rng.insertNode(dom.create('span',{'data-mce-type':"bookmark",id:id+'_start',style:styles},chr));}
selection.moveToBookmark({id:id,keep:1});return{id:id};};this.moveToBookmark=function(bookmark){var rng,root,startContainer,endContainer,startOffset,endOffset;function setEndPoint(start){var point=bookmark[start?'start':'end'],i,node,offset,children;if(point){offset=point[0];for(node=root,i=point.length-1;i>=1;i--){children=node.childNodes;if(point[i]>children.length-1){return;}
node=children[point[i]];}
if(node.nodeType===3){offset=Math.min(point[0],node.nodeValue.length);}
if(node.nodeType===1){offset=Math.min(point[0],node.childNodes.length);}
if(start){rng.setStart(node,offset);}else{rng.setEnd(node,offset);}}
return true;}
function restoreEndPoint(suffix){var marker=dom.get(bookmark.id+'_'+suffix),node,idx,next,prev,keep=bookmark.keep;if(marker){node=marker.parentNode;if(suffix=='start'){if(!keep){idx=dom.nodeIndex(marker);}else{node=marker.firstChild;idx=1;}
startContainer=endContainer=node;startOffset=endOffset=idx;}else{if(!keep){idx=dom.nodeIndex(marker);}else{node=marker.firstChild;idx=1;}
endContainer=node;endOffset=idx;}
if(!keep){prev=marker.previousSibling;next=marker.nextSibling;Tools.each(Tools.grep(marker.childNodes),function(node){if(node.nodeType==3){node.nodeValue=node.nodeValue.replace(/\uFEFF/g,'');}});while((marker=dom.get(bookmark.id+'_'+suffix))){dom.remove(marker,1);}
if(prev&&next&&prev.nodeType==next.nodeType&&prev.nodeType==3&&!Env.opera){idx=prev.nodeValue.length;prev.appendData(next.nodeValue);dom.remove(next);if(suffix=='start'){startContainer=endContainer=prev;startOffset=endOffset=idx;}else{endContainer=prev;endOffset=idx;}}}}}
function addBogus(node){if(dom.isBlock(node)&&!node.innerHTML&&!Env.ie){node.innerHTML='<br data-mce-bogus="1" />';}
return node;}
if(bookmark){if(bookmark.start){rng=dom.createRng();root=dom.getRoot();if(selection.tridentSel){return selection.tridentSel.moveToBookmark(bookmark);}
if(setEndPoint(true)&&setEndPoint()){selection.setRng(rng);}}else if(bookmark.id){restoreEndPoint('start');restoreEndPoint('end');if(startContainer){rng=dom.createRng();rng.setStart(addBogus(startContainer),startOffset);rng.setEnd(addBogus(endContainer),endOffset);selection.setRng(rng);}}else if(bookmark.name){selection.select(dom.select(bookmark.name)[bookmark.index]);}else if(bookmark.rng){selection.setRng(bookmark.rng);}}};}
BookmarkManager.isBookmarkNode=function(node){return node&&node.tagName==='SPAN'&&node.getAttribute('data-mce-type')==='bookmark';};return BookmarkManager;});