
define("tinymce/EnterKey",["tinymce/dom/TreeWalker","tinymce/dom/RangeUtils","tinymce/Env"],function(TreeWalker,RangeUtils,Env){var isIE=Env.ie&&Env.ie<11;return function(editor){var dom=editor.dom,selection=editor.selection,settings=editor.settings;var undoManager=editor.undoManager,schema=editor.schema,nonEmptyElementsMap=schema.getNonEmptyElements();function handleEnterKey(evt){var rng,tmpRng,editableRoot,container,offset,parentBlock,documentMode,shiftKey,newBlock,fragment,containerBlock,parentBlockName,containerBlockName,newBlockName,isAfterLastNodeInContainer;function canSplitBlock(node){return node&&dom.isBlock(node)&&!/^(TD|TH|CAPTION|FORM)$/.test(node.nodeName)&&!/^(fixed|absolute)/i.test(node.style.position)&&dom.getContentEditable(node)!=="true";}
function renderBlockOnIE(block){var oldRng;if(dom.isBlock(block)){oldRng=selection.getRng();block.appendChild(dom.create('span',null,'\u00a0'));selection.select(block);block.lastChild.outerHTML='';selection.setRng(oldRng);}}
function trimInlineElementsOnLeftSideOfBlock(block){var node=block,firstChilds=[],i;if(!node){return;}
while((node=node.firstChild)){if(dom.isBlock(node)){return;}
if(node.nodeType==1&&!nonEmptyElementsMap[node.nodeName.toLowerCase()]){firstChilds.push(node);}}
i=firstChilds.length;while(i--){node=firstChilds[i];if(!node.hasChildNodes()||(node.firstChild==node.lastChild&&node.firstChild.nodeValue==='')){dom.remove(node);}else{if(node.nodeName=="A"&&(node.innerText||node.textContent)===' '){dom.remove(node);}}}}
function moveToCaretPosition(root){var walker,node,rng,lastNode=root,tempElm;function firstNonWhiteSpaceNodeSibling(node){while(node){if(node.nodeType==1||(node.nodeType==3&&node.data&&/[\r\n\s]/.test(node.data))){return node;}
node=node.nextSibling;}}
if(!root){return;}
if(Env.ie&&Env.ie<9&&parentBlock&&parentBlock.firstChild){if(parentBlock.firstChild==parentBlock.lastChild&&parentBlock.firstChild.tagName=='BR'){dom.remove(parentBlock.firstChild);}}
if(/^(LI|DT|DD)$/.test(root.nodeName)){var firstChild=firstNonWhiteSpaceNodeSibling(root.firstChild);if(firstChild&&/^(UL|OL|DL)$/.test(firstChild.nodeName)){root.insertBefore(dom.doc.createTextNode('\u00a0'),root.firstChild);}}
rng=dom.createRng();if(!Env.ie){root.normalize();}
if(root.hasChildNodes()){walker=new TreeWalker(root,root);while((node=walker.current())){if(node.nodeType==3){rng.setStart(node,0);rng.setEnd(node,0);break;}
if(nonEmptyElementsMap[node.nodeName.toLowerCase()]){rng.setStartBefore(node);rng.setEndBefore(node);break;}
lastNode=node;node=walker.next();}
if(!node){rng.setStart(lastNode,0);rng.setEnd(lastNode,0);}}else{if(root.nodeName=='BR'){if(root.nextSibling&&dom.isBlock(root.nextSibling)){if(!documentMode||documentMode<9){tempElm=dom.create('br');root.parentNode.insertBefore(tempElm,root);}
rng.setStartBefore(root);rng.setEndBefore(root);}else{rng.setStartAfter(root);rng.setEndAfter(root);}}else{rng.setStart(root,0);rng.setEnd(root,0);}}
selection.setRng(rng);dom.remove(tempElm);selection.scrollIntoView(root);}
function setForcedBlockAttrs(node){var forcedRootBlockName=settings.forced_root_block;if(forcedRootBlockName&&forcedRootBlockName.toLowerCase()===node.tagName.toLowerCase()){dom.setAttribs(node,settings.forced_root_block_attrs);}}
function createNewBlock(name){var node=container,block,clonedNode,caretNode,textInlineElements=schema.getTextInlineElements();if(name||parentBlockName=="TABLE"){block=dom.create(name||newBlockName);setForcedBlockAttrs(block);}else{block=parentBlock.cloneNode(false);}
caretNode=block;if(settings.keep_styles!==false){do{if(textInlineElements[node.nodeName]){if(node.id=='_mce_caret'){continue;}
clonedNode=node.cloneNode(false);dom.setAttrib(clonedNode,'id','');if(block.hasChildNodes()){clonedNode.appendChild(block.firstChild);block.appendChild(clonedNode);}else{caretNode=clonedNode;block.appendChild(clonedNode);}}}while((node=node.parentNode));}
if(!isIE){caretNode.innerHTML='<br data-mce-bogus="1">';}
return block;}
function isCaretAtStartOrEndOfBlock(start){var walker,node,name;if(container.nodeType==3&&(start?offset>0:offset<container.nodeValue.length)){return false;}
if(container.parentNode==parentBlock&&isAfterLastNodeInContainer&&!start){return true;}
if(start&&container.nodeType==1&&container==parentBlock.firstChild){return true;}
if(container.nodeName==="TABLE"||(container.previousSibling&&container.previousSibling.nodeName=="TABLE")){return(isAfterLastNodeInContainer&&!start)||(!isAfterLastNodeInContainer&&start);}
walker=new TreeWalker(container,parentBlock);if(container.nodeType==3){if(start&&offset===0){walker.prev();}else if(!start&&offset==container.nodeValue.length){walker.next();}}
while((node=walker.current())){if(node.nodeType===1){if(!node.getAttribute('data-mce-bogus')){name=node.nodeName.toLowerCase();if(nonEmptyElementsMap[name]&&name!=='br'){return false;}}}else if(node.nodeType===3&&!/^[ \t\r\n]*$/.test(node.nodeValue)){return false;}
if(start){walker.prev();}else{walker.next();}}
return true;}
function wrapSelfAndSiblingsInDefaultBlock(container,offset){var newBlock,parentBlock,startNode,node,next,rootBlockName,blockName=newBlockName||'P';parentBlock=dom.getParent(container,dom.isBlock);rootBlockName=editor.getBody().nodeName.toLowerCase();if(!parentBlock||!canSplitBlock(parentBlock)){parentBlock=parentBlock||editableRoot;if(!parentBlock.hasChildNodes()){newBlock=dom.create(blockName);setForcedBlockAttrs(newBlock);parentBlock.appendChild(newBlock);rng.setStart(newBlock,0);rng.setEnd(newBlock,0);return newBlock;}
node=container;while(node.parentNode!=parentBlock){node=node.parentNode;}
while(node&&!dom.isBlock(node)){startNode=node;node=node.previousSibling;}
if(startNode&&schema.isValidChild(rootBlockName,blockName.toLowerCase())){newBlock=dom.create(blockName);setForcedBlockAttrs(newBlock);startNode.parentNode.insertBefore(newBlock,startNode);node=startNode;while(node&&!dom.isBlock(node)){next=node.nextSibling;newBlock.appendChild(node);node=next;}
rng.setStart(container,offset);rng.setEnd(container,offset);}}
return container;}
function handleEmptyListItem(){function isFirstOrLastLi(first){var node=containerBlock[first?'firstChild':'lastChild'];while(node){if(node.nodeType==1){break;}
node=node[first?'nextSibling':'previousSibling'];}
return node===parentBlock;}
function getContainerBlock(){var containerBlockParent=containerBlock.parentNode;if(/^(LI|DT|DD)$/.test(containerBlockParent.nodeName)){return containerBlockParent;}
return containerBlock;}
var containerBlockParentName=containerBlock.parentNode.nodeName;if(/^(OL|UL|LI)$/.test(containerBlockParentName)){newBlockName='LI';}
newBlock=newBlockName?createNewBlock(newBlockName):dom.create('BR');if(isFirstOrLastLi(true)&&isFirstOrLastLi()){if(containerBlockParentName=='LI'){dom.insertAfter(newBlock,getContainerBlock());}else{dom.replace(newBlock,containerBlock);}}else if(isFirstOrLastLi(true)){if(containerBlockParentName=='LI'){dom.insertAfter(newBlock,getContainerBlock());newBlock.appendChild(dom.doc.createTextNode(' '));newBlock.appendChild(containerBlock);}else{containerBlock.parentNode.insertBefore(newBlock,containerBlock);}}else if(isFirstOrLastLi()){dom.insertAfter(newBlock,getContainerBlock());renderBlockOnIE(newBlock);}else{containerBlock=getContainerBlock();tmpRng=rng.cloneRange();tmpRng.setStartAfter(parentBlock);tmpRng.setEndAfter(containerBlock);fragment=tmpRng.extractContents();if(newBlockName=='LI'&&fragment.firstChild.nodeName=='LI'){newBlock=fragment.firstChild;dom.insertAfter(fragment,containerBlock);}else{dom.insertAfter(fragment,containerBlock);dom.insertAfter(newBlock,containerBlock);}}
dom.remove(parentBlock);moveToCaretPosition(newBlock);undoManager.add();}
function insertBr(){editor.execCommand("InsertLineBreak",false,evt);}
function trimLeadingLineBreaks(node){do{if(node.nodeType===3){node.nodeValue=node.nodeValue.replace(/^[\r\n]+/,'');}
node=node.firstChild;}while(node);}
function getEditableRoot(node){var root=dom.getRoot(),parent,editableRoot;parent=node;while(parent!==root&&dom.getContentEditable(parent)!=="false"){if(dom.getContentEditable(parent)==="true"){editableRoot=parent;}
parent=parent.parentNode;}
return parent!==root?editableRoot:root;}
function addBrToBlockIfNeeded(block){var lastChild;if(!isIE){block.normalize();lastChild=block.lastChild;if(!lastChild||(/^(left|right)$/gi.test(dom.getStyle(lastChild,'float',true)))){dom.add(block,'br');}}}
rng=selection.getRng(true);if(evt.isDefaultPrevented()){return;}
if(!rng.collapsed){editor.execCommand('Delete');return;}
new RangeUtils(dom).normalize(rng);container=rng.startContainer;offset=rng.startOffset;newBlockName=(settings.force_p_newlines?'p':'')||settings.forced_root_block;newBlockName=newBlockName?newBlockName.toUpperCase():'';documentMode=dom.doc.documentMode;shiftKey=evt.shiftKey;if(container.nodeType==1&&container.hasChildNodes()){isAfterLastNodeInContainer=offset>container.childNodes.length-1;container=container.childNodes[Math.min(offset,container.childNodes.length-1)]||container;if(isAfterLastNodeInContainer&&container.nodeType==3){offset=container.nodeValue.length;}else{offset=0;}}
editableRoot=getEditableRoot(container);if(!editableRoot){return;}
undoManager.beforeChange();if(!dom.isBlock(editableRoot)&&editableRoot!=dom.getRoot()){if(!newBlockName||shiftKey){insertBr();}
return;}
if((newBlockName&&!shiftKey)||(!newBlockName&&shiftKey)){container=wrapSelfAndSiblingsInDefaultBlock(container,offset);}
parentBlock=dom.getParent(container,dom.isBlock);containerBlock=parentBlock?dom.getParent(parentBlock.parentNode,dom.isBlock):null;parentBlockName=parentBlock?parentBlock.nodeName.toUpperCase():'';containerBlockName=containerBlock?containerBlock.nodeName.toUpperCase():'';if(containerBlockName=='LI'&&!evt.ctrlKey){parentBlock=containerBlock;parentBlockName=containerBlockName;}
if(/^(LI|DT|DD)$/.test(parentBlockName)){if(!newBlockName&&shiftKey){insertBr();return;}
if(dom.isEmpty(parentBlock)){handleEmptyListItem();return;}}
if(parentBlockName=='PRE'&&settings.br_in_pre!==false){if(!shiftKey){insertBr();return;}}else{if((!newBlockName&&!shiftKey&&parentBlockName!='LI')||(newBlockName&&shiftKey)){insertBr();return;}}
if(newBlockName&&parentBlock===editor.getBody()){return;}
newBlockName=newBlockName||'P';if(isCaretAtStartOrEndOfBlock()){if(/^(H[1-6]|PRE|FIGURE)$/.test(parentBlockName)&&containerBlockName!='HGROUP'){newBlock=createNewBlock(newBlockName);}else{newBlock=createNewBlock();}
if(settings.end_container_on_empty_block&&canSplitBlock(containerBlock)&&dom.isEmpty(parentBlock)){newBlock=dom.split(containerBlock,parentBlock);}else{dom.insertAfter(newBlock,parentBlock);}
moveToCaretPosition(newBlock);}else if(isCaretAtStartOrEndOfBlock(true)){newBlock=parentBlock.parentNode.insertBefore(createNewBlock(),parentBlock);renderBlockOnIE(newBlock);moveToCaretPosition(parentBlock);}else{tmpRng=rng.cloneRange();tmpRng.setEndAfter(parentBlock);fragment=tmpRng.extractContents();trimLeadingLineBreaks(fragment);newBlock=fragment.firstChild;dom.insertAfter(fragment,parentBlock);trimInlineElementsOnLeftSideOfBlock(newBlock);addBrToBlockIfNeeded(parentBlock);moveToCaretPosition(newBlock);}
dom.setAttrib(newBlock,'id','');editor.fire('NewBlock',{newBlock:newBlock});undoManager.add();}
editor.on('keydown',function(evt){if(evt.keyCode==13){if(handleEnterKey(evt)!==false){evt.preventDefault();}}});};});