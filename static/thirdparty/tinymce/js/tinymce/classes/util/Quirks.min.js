
define("tinymce/util/Quirks",["tinymce/util/VK","tinymce/dom/RangeUtils","tinymce/html/Node","tinymce/html/Entities","tinymce/Env","tinymce/util/Tools"],function(VK,RangeUtils,Node,Entities,Env,Tools){return function(editor){var each=Tools.each;var BACKSPACE=VK.BACKSPACE,DELETE=VK.DELETE,dom=editor.dom,selection=editor.selection,settings=editor.settings,parser=editor.parser,serializer=editor.serializer;var isGecko=Env.gecko,isIE=Env.ie,isWebKit=Env.webkit;function setEditorCommandState(cmd,state){try{editor.getDoc().execCommand(cmd,false,state);}catch(ex){}}
function getDocumentMode(){var documentMode=editor.getDoc().documentMode;return documentMode?documentMode:6;}
function isDefaultPrevented(e){return e.isDefaultPrevented();}
function cleanupStylesWhenDeleting(){var doc=editor.getDoc(),urlPrefix='data:text/mce-internal,';var MutationObserver=window.MutationObserver,olderWebKit,dragStartRng;if(!MutationObserver){olderWebKit=true;MutationObserver=function(){var records=[],target;function nodeInsert(e){var target=e.relatedNode||e.target;records.push({target:target,addedNodes:[target]});}
function attrModified(e){var target=e.relatedNode||e.target;records.push({target:target,attributeName:e.attrName});}
this.observe=function(node){target=node;target.addEventListener('DOMSubtreeModified',nodeInsert,false);target.addEventListener('DOMNodeInsertedIntoDocument',nodeInsert,false);target.addEventListener('DOMNodeInserted',nodeInsert,false);target.addEventListener('DOMAttrModified',attrModified,false);};this.disconnect=function(){target.removeEventListener('DOMSubtreeModified',nodeInsert,false);target.removeEventListener('DOMNodeInsertedIntoDocument',nodeInsert,false);target.removeEventListener('DOMNodeInserted',nodeInsert,false);target.removeEventListener('DOMAttrModified',attrModified,false);};this.takeRecords=function(){return records;};};}
function customDelete(isForward){var mutationObserver=new MutationObserver(function(){});Tools.each(editor.getBody().getElementsByTagName('*'),function(elm){if(elm.tagName=='SPAN'){elm.setAttribute('mce-data-marked',1);}
if(!elm.hasAttribute('data-mce-style')&&elm.hasAttribute('style')){editor.dom.setAttrib(elm,'style',editor.dom.getAttrib(elm,'style'));}});mutationObserver.observe(editor.getDoc(),{childList:true,attributes:true,subtree:true,attributeFilter:['style']});editor.getDoc().execCommand(isForward?'ForwardDelete':'Delete',false,null);var rng=editor.selection.getRng();var caretElement=rng.startContainer.parentNode;Tools.each(mutationObserver.takeRecords(),function(record){if(!dom.isChildOf(record.target,editor.getBody())){return;}
if(record.attributeName=="style"){var oldValue=record.target.getAttribute('data-mce-style');if(oldValue){record.target.setAttribute("style",oldValue);}else{record.target.removeAttribute("style");}}
Tools.each(record.addedNodes,function(node){if(node.nodeName=="SPAN"&&!node.getAttribute('mce-data-marked')){var offset,container;if(node==caretElement){offset=rng.startOffset;container=node.firstChild;}
dom.remove(node,true);if(container){rng.setStart(container,offset);rng.setEnd(container,offset);editor.selection.setRng(rng);}}});});mutationObserver.disconnect();Tools.each(editor.dom.select('span[mce-data-marked]'),function(span){span.removeAttribute('mce-data-marked');});}
editor.on('keydown',function(e){var isForward=e.keyCode==DELETE,isMeta=VK.metaKeyPressed(e);if(!isDefaultPrevented(e)&&(isForward||e.keyCode==BACKSPACE)){var rng=editor.selection.getRng(),container=rng.startContainer,offset=rng.startOffset;if(!isMeta&&rng.collapsed&&container.nodeType==3){if(isForward?offset<container.data.length:offset>0){return;}}
e.preventDefault();if(isMeta){editor.selection.getSel().modify("extend",isForward?"forward":"backward","word");}
customDelete(isForward);}});editor.on('keypress',function(e){if(!isDefaultPrevented(e)&&!selection.isCollapsed()&&e.charCode&&!VK.metaKeyPressed(e)){e.preventDefault();customDelete(true);editor.selection.setContent(String.fromCharCode(e.charCode));}});editor.addCommand('Delete',function(){customDelete();});editor.addCommand('ForwardDelete',function(){customDelete(true);});if(olderWebKit){return;}
editor.on('dragstart',function(e){var selectionHtml;if(editor.selection.isCollapsed()&&e.target.tagName=='IMG'){selection.select(e.target);}
dragStartRng=selection.getRng();selectionHtml=editor.selection.getContent();if(selectionHtml.length>0){e.dataTransfer.setData('URL','data:text/mce-internal,'+escape(selectionHtml));}});editor.on('drop',function(e){if(!isDefaultPrevented(e)){var internalContent=e.dataTransfer.getData('URL');if(!internalContent||internalContent.indexOf(urlPrefix)==-1||!doc.caretRangeFromPoint){return;}
internalContent=unescape(internalContent.substr(urlPrefix.length));if(doc.caretRangeFromPoint){e.preventDefault();window.setTimeout(function(){var pointRng=doc.caretRangeFromPoint(e.x,e.y);if(dragStartRng){selection.setRng(dragStartRng);dragStartRng=null;}
customDelete();selection.setRng(pointRng);editor.insertContent(internalContent);},0);}}});editor.on('cut',function(e){if(!isDefaultPrevented(e)&&e.clipboardData){e.preventDefault();e.clipboardData.clearData();e.clipboardData.setData('text/html',editor.selection.getContent());e.clipboardData.setData('text/plain',editor.selection.getContent({format:'text'}));customDelete(true);}});}
function emptyEditorWhenDeleting(){function serializeRng(rng){var body=dom.create("body");var contents=rng.cloneContents();body.appendChild(contents);return selection.serializer.serialize(body,{format:'html'});}
function allContentsSelected(rng){if(!rng.setStart){if(rng.item){return false;}
var bodyRng=rng.duplicate();bodyRng.moveToElementText(editor.getBody());return RangeUtils.compareRanges(rng,bodyRng);}
var selection=serializeRng(rng);var allRng=dom.createRng();allRng.selectNode(editor.getBody());var allSelection=serializeRng(allRng);return selection===allSelection;}
editor.on('keydown',function(e){var keyCode=e.keyCode,isCollapsed,body;if(!isDefaultPrevented(e)&&(keyCode==DELETE||keyCode==BACKSPACE)){isCollapsed=editor.selection.isCollapsed();body=editor.getBody();if(isCollapsed&&!dom.isEmpty(body)){return;}
if(!isCollapsed&&!allContentsSelected(editor.selection.getRng())){return;}
e.preventDefault();editor.setContent('');if(body.firstChild&&dom.isBlock(body.firstChild)){editor.selection.setCursorLocation(body.firstChild,0);}else{editor.selection.setCursorLocation(body,0);}
editor.nodeChanged();}});}
function selectAll(){editor.on('keydown',function(e){if(!isDefaultPrevented(e)&&e.keyCode==65&&VK.metaKeyPressed(e)){e.preventDefault();editor.execCommand('SelectAll');}});}
function inputMethodFocus(){if(!editor.settings.content_editable){dom.bind(editor.getDoc(),'focusin',function(){selection.setRng(selection.getRng());});dom.bind(editor.getDoc(),'mousedown',function(e){if(e.target==editor.getDoc().documentElement){editor.getBody().focus();selection.setRng(selection.getRng());}});}}
function removeHrOnBackspace(){editor.on('keydown',function(e){if(!isDefaultPrevented(e)&&e.keyCode===BACKSPACE){if(!editor.getBody().getElementsByTagName('hr').length){return;}
if(selection.isCollapsed()&&selection.getRng(true).startOffset===0){var node=selection.getNode();var previousSibling=node.previousSibling;if(node.nodeName=='HR'){dom.remove(node);e.preventDefault();return;}
if(previousSibling&&previousSibling.nodeName&&previousSibling.nodeName.toLowerCase()==="hr"){dom.remove(previousSibling);e.preventDefault();}}}});}
function focusBody(){if(!window.Range.prototype.getClientRects){editor.on('mousedown',function(e){if(!isDefaultPrevented(e)&&e.target.nodeName==="HTML"){var body=editor.getBody();body.blur();setTimeout(function(){body.focus();},0);}});}}
function selectControlElements(){editor.on('click',function(e){var target=e.target;if(/^(IMG|HR)$/.test(target.nodeName)){e.preventDefault();selection.getSel().setBaseAndExtent(target,0,target,1);}
if(target.nodeName=='A'&&dom.hasClass(target,'mce-item-anchor')){e.preventDefault();selection.select(target);}});}
function removeStylesWhenDeletingAcrossBlockElements(){function getAttributeApplyFunction(){var template=dom.getAttribs(selection.getStart().cloneNode(false));return function(){var target=selection.getStart();if(target!==editor.getBody()){dom.setAttrib(target,"style",null);each(template,function(attr){target.setAttributeNode(attr.cloneNode(true));});}};}
function isSelectionAcrossElements(){return!selection.isCollapsed()&&dom.getParent(selection.getStart(),dom.isBlock)!=dom.getParent(selection.getEnd(),dom.isBlock);}
editor.on('keypress',function(e){var applyAttributes;if(!isDefaultPrevented(e)&&(e.keyCode==8||e.keyCode==46)&&isSelectionAcrossElements()){applyAttributes=getAttributeApplyFunction();editor.getDoc().execCommand('delete',false,null);applyAttributes();e.preventDefault();return false;}});dom.bind(editor.getDoc(),'cut',function(e){var applyAttributes;if(!isDefaultPrevented(e)&&isSelectionAcrossElements()){applyAttributes=getAttributeApplyFunction();setTimeout(function(){applyAttributes();},0);}});}
function ensureBodyHasRoleApplication(){document.body.setAttribute("role","application");}
function disableBackspaceIntoATable(){editor.on('keydown',function(e){if(!isDefaultPrevented(e)&&e.keyCode===BACKSPACE){if(selection.isCollapsed()&&selection.getRng(true).startOffset===0){var previousSibling=selection.getNode().previousSibling;if(previousSibling&&previousSibling.nodeName&&previousSibling.nodeName.toLowerCase()==="table"){e.preventDefault();return false;}}}});}
function addNewLinesBeforeBrInPre(){if(getDocumentMode()>7){return;}
setEditorCommandState('RespectVisibilityInDesign',true);editor.contentStyles.push('.mceHideBrInPre pre br {display: none}');dom.addClass(editor.getBody(),'mceHideBrInPre');parser.addNodeFilter('pre',function(nodes){var i=nodes.length,brNodes,j,brElm,sibling;while(i--){brNodes=nodes[i].getAll('br');j=brNodes.length;while(j--){brElm=brNodes[j];sibling=brElm.prev;if(sibling&&sibling.type===3&&sibling.value.charAt(sibling.value-1)!='\n'){sibling.value+='\n';}else{brElm.parent.insert(new Node('#text',3),brElm,true).value='\n';}}}});serializer.addNodeFilter('pre',function(nodes){var i=nodes.length,brNodes,j,brElm,sibling;while(i--){brNodes=nodes[i].getAll('br');j=brNodes.length;while(j--){brElm=brNodes[j];sibling=brElm.prev;if(sibling&&sibling.type==3){sibling.value=sibling.value.replace(/\r?\n$/,'');}}}});}
function removePreSerializedStylesWhenSelectingControls(){dom.bind(editor.getBody(),'mouseup',function(){var value,node=selection.getNode();if(node.nodeName=='IMG'){if((value=dom.getStyle(node,'width'))){dom.setAttrib(node,'width',value.replace(/[^0-9%]+/g,''));dom.setStyle(node,'width','');}
if((value=dom.getStyle(node,'height'))){dom.setAttrib(node,'height',value.replace(/[^0-9%]+/g,''));dom.setStyle(node,'height','');}}});}
function removeBlockQuoteOnBackSpace(){editor.on('keydown',function(e){var rng,container,offset,root,parent;if(isDefaultPrevented(e)||e.keyCode!=VK.BACKSPACE){return;}
rng=selection.getRng();container=rng.startContainer;offset=rng.startOffset;root=dom.getRoot();parent=container;if(!rng.collapsed||offset!==0){return;}
while(parent&&parent.parentNode&&parent.parentNode.firstChild==parent&&parent.parentNode!=root){parent=parent.parentNode;}
if(parent.tagName==='BLOCKQUOTE'){editor.formatter.toggle('blockquote',null,parent);rng=dom.createRng();rng.setStart(container,0);rng.setEnd(container,0);selection.setRng(rng);}});}
function setGeckoEditingOptions(){function setOpts(){editor._refreshContentEditable();setEditorCommandState("StyleWithCSS",false);setEditorCommandState("enableInlineTableEditing",false);if(!settings.object_resizing){setEditorCommandState("enableObjectResizing",false);}}
if(!settings.readonly){editor.on('BeforeExecCommand MouseDown',setOpts);}}
function addBrAfterLastLinks(){function fixLinks(){each(dom.select('a'),function(node){var parentNode=node.parentNode,root=dom.getRoot();if(parentNode.lastChild===node){while(parentNode&&!dom.isBlock(parentNode)){if(parentNode.parentNode.lastChild!==parentNode||parentNode===root){return;}
parentNode=parentNode.parentNode;}
dom.add(parentNode,'br',{'data-mce-bogus':1});}});}
editor.on('SetContent ExecCommand',function(e){if(e.type=="setcontent"||e.command==='mceInsertLink'){fixLinks();}});}
function setDefaultBlockType(){if(settings.forced_root_block){editor.on('init',function(){setEditorCommandState('DefaultParagraphSeparator',settings.forced_root_block);});}}
function removeGhostSelection(){editor.on('Undo Redo SetContent',function(e){if(!e.initial){editor.execCommand('mceRepaint');}});}
function deleteControlItemOnBackSpace(){editor.on('keydown',function(e){var rng;if(!isDefaultPrevented(e)&&e.keyCode==BACKSPACE){rng=editor.getDoc().selection.createRange();if(rng&&rng.item){e.preventDefault();editor.undoManager.beforeChange();dom.remove(rng.item(0));editor.undoManager.add();}}});}
function renderEmptyBlocksFix(){var emptyBlocksCSS;if(getDocumentMode()>=10){emptyBlocksCSS='';each('p div h1 h2 h3 h4 h5 h6'.split(' '),function(name,i){emptyBlocksCSS+=(i>0?',':'')+name+':empty';});editor.contentStyles.push(emptyBlocksCSS+'{padding-right: 1px !important}');}}
function keepNoScriptContents(){if(getDocumentMode()<9){parser.addNodeFilter('noscript',function(nodes){var i=nodes.length,node,textNode;while(i--){node=nodes[i];textNode=node.firstChild;if(textNode){node.attr('data-mce-innertext',textNode.value);}}});serializer.addNodeFilter('noscript',function(nodes){var i=nodes.length,node,textNode,value;while(i--){node=nodes[i];textNode=nodes[i].firstChild;if(textNode){textNode.value=Entities.decode(textNode.value);}else{value=node.attributes.map['data-mce-innertext'];if(value){node.attr('data-mce-innertext',null);textNode=new Node('#text',3);textNode.value=value;textNode.raw=true;node.append(textNode);}}}});}}
function fixCaretSelectionOfDocumentElementOnIe(){var doc=dom.doc,body=doc.body,started,startRng,htmlElm;function rngFromPoint(x,y){var rng=body.createTextRange();try{rng.moveToPoint(x,y);}catch(ex){rng=null;}
return rng;}
function selectionChange(e){var pointRng;if(e.button){pointRng=rngFromPoint(e.x,e.y);if(pointRng){if(pointRng.compareEndPoints('StartToStart',startRng)>0){pointRng.setEndPoint('StartToStart',startRng);}else{pointRng.setEndPoint('EndToEnd',startRng);}
pointRng.select();}}else{endSelection();}}
function endSelection(){var rng=doc.selection.createRange();if(startRng&&!rng.item&&rng.compareEndPoints('StartToEnd',rng)===0){startRng.select();}
dom.unbind(doc,'mouseup',endSelection);dom.unbind(doc,'mousemove',selectionChange);startRng=started=0;}
doc.documentElement.unselectable=true;dom.bind(doc,'mousedown contextmenu',function(e){if(e.target.nodeName==='HTML'){if(started){endSelection();}
htmlElm=doc.documentElement;if(htmlElm.scrollHeight>htmlElm.clientHeight){return;}
started=1;startRng=rngFromPoint(e.x,e.y);if(startRng){dom.bind(doc,'mouseup',endSelection);dom.bind(doc,'mousemove',selectionChange);dom.getRoot().focus();startRng.select();}}});}
function normalizeSelection(){editor.on('keyup focusin mouseup',function(e){if(e.keyCode!=65||!VK.metaKeyPressed(e)){selection.normalize();}},true);}
function showBrokenImageIcon(){editor.contentStyles.push('img:-moz-broken {'+'-moz-force-broken-image-icon:1;'+'min-width:24px;'+'min-height:24px'+'}');}
function restoreFocusOnKeyDown(){if(!editor.inline){editor.on('keydown',function(){if(document.activeElement==document.body){editor.getWin().focus();}});}}
function bodyHeight(){if(!editor.inline){editor.contentStyles.push('body {min-height: 150px}');editor.on('click',function(e){if(e.target.nodeName=='HTML'){editor.getBody().focus();editor.selection.normalize();editor.nodeChanged();}});}}
function blockCmdArrowNavigation(){if(Env.mac){editor.on('keydown',function(e){if(VK.metaKeyPressed(e)&&(e.keyCode==37||e.keyCode==39)){e.preventDefault();editor.selection.getSel().modify('move',e.keyCode==37?'backward':'forward','word');}});}}
function disableAutoUrlDetect(){setEditorCommandState("AutoUrlDetect",false);}
function doubleTrailingBrElements(){if(!editor.inline){editor.on('focus blur beforegetcontent',function(){var br=editor.dom.create('br');editor.getBody().appendChild(br);br.parentNode.removeChild(br);},true);}}
function tapLinksAndImages(){editor.on('click',function(e){var elm=e.target;do{if(elm.tagName==='A'){e.preventDefault();return;}}while((elm=elm.parentNode));});editor.contentStyles.push('.mce-content-body {-webkit-touch-callout: none}');}
function touchClickEvent(){editor.on('touchstart',function(e){var elm,time,startTouch,changedTouches;elm=e.target;time=new Date().getTime();changedTouches=e.changedTouches;if(!changedTouches||changedTouches.length>1){return;}
startTouch=changedTouches[0];editor.once('touchend',function(e){var endTouch=e.changedTouches[0],args;if(new Date().getTime()-time>500){return;}
if(Math.abs(startTouch.clientX-endTouch.clientX)>5){return;}
if(Math.abs(startTouch.clientY-endTouch.clientY)>5){return;}
args={target:elm};each('pageX pageY clientX clientY screenX screenY'.split(' '),function(key){args[key]=endTouch[key];});args=editor.fire('click',args);if(!args.isDefaultPrevented()){editor.selection.placeCaretAt(endTouch.clientX,endTouch.clientY);}});});}
function blockFormSubmitInsideEditor(){editor.on('init',function(){editor.dom.bind(editor.getBody(),'submit',function(e){e.preventDefault();});});}
function removeAppleInterchangeBrs(){parser.addNodeFilter('br',function(nodes){var i=nodes.length;while(i--){if(nodes[i].attr('class')=='Apple-interchange-newline'){nodes[i].remove();}}});}
removeBlockQuoteOnBackSpace();emptyEditorWhenDeleting();normalizeSelection();if(isWebKit){cleanupStylesWhenDeleting();inputMethodFocus();selectControlElements();setDefaultBlockType();blockFormSubmitInsideEditor();disableBackspaceIntoATable();removeAppleInterchangeBrs();touchClickEvent();if(Env.iOS){restoreFocusOnKeyDown();bodyHeight();tapLinksAndImages();}else{selectAll();}}
if(isIE&&Env.ie<11){removeHrOnBackspace();ensureBodyHasRoleApplication();addNewLinesBeforeBrInPre();removePreSerializedStylesWhenSelectingControls();deleteControlItemOnBackSpace();renderEmptyBlocksFix();keepNoScriptContents();fixCaretSelectionOfDocumentElementOnIe();}
if(Env.ie>=11){bodyHeight();doubleTrailingBrElements();disableBackspaceIntoATable();}
if(Env.ie){selectAll();disableAutoUrlDetect();}
if(isGecko){removeHrOnBackspace();focusBody();removeStylesWhenDeletingAcrossBlockElements();setGeckoEditingOptions();addBrAfterLastLinks();removeGhostSelection();showBrokenImageIcon();blockCmdArrowNavigation();disableBackspaceIntoATable();}};});