
define("tinymce/pasteplugin/Clipboard",["tinymce/Env","tinymce/util/VK","tinymce/pasteplugin/Utils"],function(Env,VK,Utils){return function(editor){var self=this,pasteBinElm,lastRng,keyboardPasteTimeStamp=0,draggingInternally=false;var pasteBinDefaultContent='%MCEPASTEBIN%',keyboardPastePlainTextState;function pasteHtml(html){var args,dom=editor.dom;args=editor.fire('BeforePastePreProcess',{content:html});args=editor.fire('PastePreProcess',args);html=args.content;if(!args.isDefaultPrevented()){if(editor.hasEventListeners('PastePostProcess')&&!args.isDefaultPrevented()){var tempBody=dom.add(editor.getBody(),'div',{style:'display:none'},html);args=editor.fire('PastePostProcess',{node:tempBody});dom.remove(tempBody);html=args.node.innerHTML;}
if(!args.isDefaultPrevented()){editor.insertContent(html,{merge:editor.settings.paste_merge_formats!==false});}}}
function pasteText(text){text=editor.dom.encode(text).replace(/\r\n/g,'\n');var startBlock=editor.dom.getParent(editor.selection.getStart(),editor.dom.isBlock);var forcedRootBlockName=editor.settings.forced_root_block;var forcedRootBlockStartHtml;if(forcedRootBlockName){forcedRootBlockStartHtml=editor.dom.createHTML(forcedRootBlockName,editor.settings.forced_root_block_attrs);forcedRootBlockStartHtml=forcedRootBlockStartHtml.substr(0,forcedRootBlockStartHtml.length-3)+'>';}
if((startBlock&&/^(PRE|DIV)$/.test(startBlock.nodeName))||!forcedRootBlockName){text=Utils.filter(text,[[/\n/g,"<br>"]]);}else{text=Utils.filter(text,[[/\n\n/g,"</p>"+forcedRootBlockStartHtml],[/^(.*<\/p>)(<p>)$/,forcedRootBlockStartHtml+'$1'],[/\n/g,"<br />"]]);if(text.indexOf('<p>')!=-1){text=forcedRootBlockStartHtml+text;}}
pasteHtml(text);}
function createPasteBin(){var dom=editor.dom,body=editor.getBody();var viewport=editor.dom.getViewPort(editor.getWin()),scrollTop=viewport.y,top=20;var scrollContainer;lastRng=editor.selection.getRng();if(editor.inline){scrollContainer=editor.selection.getScrollContainer();if(scrollContainer&&scrollContainer.scrollTop>0){scrollTop=scrollContainer.scrollTop;}}
if(lastRng.getClientRects){var rects=lastRng.getClientRects();if(rects.length){top=scrollTop+(rects[0].top-dom.getPos(body).y);}else{top=scrollTop;var container=lastRng.startContainer;if(container){if(container.nodeType==3&&container.parentNode!=body){container=container.parentNode;}
if(container.nodeType==1){top=dom.getPos(container,scrollContainer||body).y;}}}}
pasteBinElm=dom.add(editor.getBody(),'div',{id:"mcepastebin",contentEditable:true,"data-mce-bogus":"all",style:'position: absolute; top: '+top+'px;'+'width: 10px; height: 10px; overflow: hidden; opacity: 0'},pasteBinDefaultContent);if(Env.ie||Env.gecko){dom.setStyle(pasteBinElm,'left',dom.getStyle(body,'direction',true)=='rtl'?0xFFFF:-0xFFFF);}
dom.bind(pasteBinElm,'beforedeactivate focusin focusout',function(e){e.stopPropagation();});pasteBinElm.focus();editor.selection.select(pasteBinElm,true);}
function removePasteBin(){if(pasteBinElm){var pasteBinClone;while((pasteBinClone=editor.dom.get('mcepastebin'))){editor.dom.remove(pasteBinClone);editor.dom.unbind(pasteBinClone);}
if(lastRng){editor.selection.setRng(lastRng);}}
pasteBinElm=lastRng=null;}
function getPasteBinHtml(){var html='',pasteBinClones,i,clone,cloneHtml;pasteBinClones=editor.dom.select('div[id=mcepastebin]');for(i=0;i<pasteBinClones.length;i++){clone=pasteBinClones[i];if(clone.firstChild&&clone.firstChild.id=='mcepastebin'){clone=clone.firstChild;}
cloneHtml=clone.innerHTML;if(html!=pasteBinDefaultContent){html+=cloneHtml;}}
return html;}
function getDataTransferItems(dataTransfer){var data={};if(dataTransfer){if(dataTransfer.getData){var legacyText=dataTransfer.getData('Text');if(legacyText&&legacyText.length>0){data['text/plain']=legacyText;}}
if(dataTransfer.types){for(var i=0;i<dataTransfer.types.length;i++){var contentType=dataTransfer.types[i];data[contentType]=dataTransfer.getData(contentType);}}}
return data;}
function getClipboardContent(clipboardEvent){return getDataTransferItems(clipboardEvent.clipboardData||editor.getDoc().dataTransfer);}
function pasteImageData(e,rng){var dataTransfer=e.clipboardData||e.dataTransfer;function processItems(items){var i,item,reader;function pasteImage(){if(rng){editor.selection.setRng(rng);rng=null;}
pasteHtml('<img src="'+reader.result+'">');}
if(items){for(i=0;i<items.length;i++){item=items[i];if(/^image\/(jpeg|png|gif)$/.test(item.type)){reader=new FileReader();reader.onload=pasteImage;reader.readAsDataURL(item.getAsFile?item.getAsFile():item);e.preventDefault();return true;}}}}
if(editor.settings.paste_data_images&&dataTransfer){return processItems(dataTransfer.items)||processItems(dataTransfer.files);}}
function isBrokenAndoidClipboardEvent(e){var clipboardData=e.clipboardData;return navigator.userAgent.indexOf('Android')!=-1&&clipboardData&&clipboardData.items&&clipboardData.items.length===0;}
function getCaretRangeFromEvent(e){var doc=editor.getDoc(),rng,point;if(doc.caretPositionFromPoint){point=doc.caretPositionFromPoint(e.clientX,e.clientY);rng=doc.createRange();rng.setStart(point.offsetNode,point.offset);rng.collapse(true);}else if(doc.caretRangeFromPoint){rng=doc.caretRangeFromPoint(e.clientX,e.clientY);}else if(doc.body.createTextRange){rng=doc.body.createTextRange();try{rng.moveToPoint(e.clientX,e.clientY);rng.collapse(true);}catch(ex){rng.collapse(e.clientY<doc.body.clientHeight);}}
return rng;}
function hasContentType(clipboardContent,mimeType){return mimeType in clipboardContent&&clipboardContent[mimeType].length>0;}
function isKeyboardPasteEvent(e){return(VK.metaKeyPressed(e)&&e.keyCode==86)||(e.shiftKey&&e.keyCode==45);}
function registerEventHandlers(){editor.on('keydown',function(e){function removePasteBinOnKeyUp(e){if(isKeyboardPasteEvent(e)&&!e.isDefaultPrevented()){removePasteBin();}}
if(isKeyboardPasteEvent(e)&&!e.isDefaultPrevented()){keyboardPastePlainTextState=e.shiftKey&&e.keyCode==86;if(keyboardPastePlainTextState&&Env.webkit&&navigator.userAgent.indexOf('Version/')!=-1){return;}
e.stopImmediatePropagation();keyboardPasteTimeStamp=new Date().getTime();if(Env.ie&&keyboardPastePlainTextState){e.preventDefault();editor.fire('paste',{ieFake:true});return;}
removePasteBin();createPasteBin();editor.once('keyup',removePasteBinOnKeyUp);editor.once('paste',function(){editor.off('keyup',removePasteBinOnKeyUp);});}});editor.on('paste',function(e){var clipboardTimer=new Date().getTime();var clipboardContent=getClipboardContent(e);var clipboardDelay=new Date().getTime()-clipboardTimer;var isKeyBoardPaste=(new Date().getTime()-keyboardPasteTimeStamp-clipboardDelay)<1000;var plainTextMode=self.pasteFormat=="text"||keyboardPastePlainTextState;keyboardPastePlainTextState=false;if(e.isDefaultPrevented()||isBrokenAndoidClipboardEvent(e)){removePasteBin();return;}
if(pasteImageData(e)){removePasteBin();return;}
if(!isKeyBoardPaste){e.preventDefault();}
if(Env.ie&&(!isKeyBoardPaste||e.ieFake)){createPasteBin();editor.dom.bind(pasteBinElm,'paste',function(e){e.stopPropagation();});editor.getDoc().execCommand('Paste',false,null);clipboardContent["text/html"]=getPasteBinHtml();}
setTimeout(function(){var content;if(hasContentType(clipboardContent,'text/html')){content=clipboardContent['text/html'];}else{content=getPasteBinHtml();if(content==pasteBinDefaultContent){plainTextMode=true;}}
content=Utils.trimHtml(content);if(pasteBinElm&&pasteBinElm.firstChild&&pasteBinElm.firstChild.id==='mcepastebin'){plainTextMode=true;}
removePasteBin();if(!content.length){plainTextMode=true;}
if(plainTextMode){if(hasContentType(clipboardContent,'text/plain')&&content.indexOf('</p>')==-1){content=clipboardContent['text/plain'];}else{content=Utils.innerText(content);}}
if(content==pasteBinDefaultContent){if(!isKeyBoardPaste){editor.windowManager.alert('Please use Ctrl+V/Cmd+V keyboard shortcuts to paste contents.');}
return;}
if(plainTextMode){pasteText(content);}else{pasteHtml(content);}},0);});editor.on('dragstart dragend',function(e){draggingInternally=e.type=='dragstart';});editor.on('drop',function(e){var rng=getCaretRangeFromEvent(e);if(e.isDefaultPrevented()||draggingInternally){return;}
if(pasteImageData(e,rng)){return;}
if(rng&&editor.settings.paste_filter_drop!==false){var dropContent=getDataTransferItems(e.dataTransfer);var content=dropContent['mce-internal']||dropContent['text/html']||dropContent['text/plain'];if(content){e.preventDefault();editor.undoManager.transact(function(){if(dropContent['mce-internal']){editor.execCommand('Delete');}
editor.selection.setRng(rng);content=Utils.trimHtml(content);if(!dropContent['text/html']){pasteText(content);}else{pasteHtml(content);}});}}});editor.on('dragover dragend',function(e){var i,dataTransfer=e.dataTransfer;if(editor.settings.paste_data_images&&dataTransfer){for(i=0;i<dataTransfer.types.length;i++){if(dataTransfer.types[i]=="Files"){e.preventDefault();return false;}}}});}
self.pasteHtml=pasteHtml;self.pasteText=pasteText;editor.on('preInit',function(){registerEventHandlers();editor.parser.addNodeFilter('img',function(nodes){if(!editor.settings.paste_data_images){var i=nodes.length;while(i--){var src=nodes[i].attributes.map.src;if(src&&/^(data:image|webkit\-fake\-url)/.test(src)){if(!nodes[i].attr('data-mce-object')&&src!==Env.transparentSrc){nodes[i].remove();}}}}});});};});