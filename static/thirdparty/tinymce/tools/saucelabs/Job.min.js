'use strict';var Q=require('q');var _=require('lodash');var utils=require('./utils');var reJobId=/^[a-z0-9]{32}$/;var resultParsers={jasmine:function(result){return result.passed;},qunit:function(result){return result.passed===result.total;},mocha:function(result){return result.failures===0;},'YUI Test':function(result){return result.passed===result.total;},custom:function(result){return result.failed===0;}};var Job=function(user,key,framework,pollInterval,url,browser,build,testName,sauceConfig,tunneled,tunnelId){this.id=null;this.taskId=null;this.user=user;this.key=key;this.framework=framework;this.pollInterval=pollInterval;this.url=url;this.platform=[browser.platform||'',browser.browserName||'',browser.version||''];this.build=build;this.testName=testName;this.sauceConfig=sauceConfig;this.tunneled=tunneled;this.tunnelId=tunnelId;};Job.prototype.start=function(){var me=this;var requestParams={method:'POST',url:['https://saucelabs.com/rest/v1',this.user,'js-tests'].join('/'),auth:{user:this.user,pass:this.key},json:{platforms:[this.platform],url:this.url,framework:this.framework,build:this.build,name:this.testName}};_.merge(requestParams.json,this.sauceConfig);if(this.tunneled){requestParams.json['tunnel-identifier']=this.tunnelId;}
return utils.makeRequest(requestParams).then(function(body){var taskIds=body['js tests'];if(!taskIds||!taskIds.length){throw'Error starting tests through Sauce API: '+JSON.stringify(body);}
me.taskId=taskIds[0];});};Job.prototype.getResult=function(){var me=this;return this.complete().then(function(result){if(result.status==='test error'){throw'Test Error';}
return result;}).then(function(result){if(result.result===null){result.passed=false;}else{result.passed=resultParsers[me.framework](result.result);}
return result;});};Job.prototype.complete=function(){var me=this;var deferred=Q.defer();function fetch(){utils.makeRequest({method:'POST',url:['https://saucelabs.com/rest/v1',me.user,'js-tests/status'].join('/'),auth:{user:me.user,pass:me.key},json:{'js tests':[me.taskId]}}).then(function(body){var result=body['js tests']&&body['js tests'][0];var jobId=result.job_id;if(!body.completed||!reJobId.test(jobId)){return Q.delay(me.pollInterval).then(fetch);}
me.id=jobId;deferred.resolve(result);}).fail(function(error){deferred.reject(error);}).done();}
fetch();return deferred.promise;};Job.prototype.stop=function(){return utils.makeRequest({method:'PUT',url:['https://saucelabs.com/rest/v1',this.user,'jobs',this.id,'stop'].join('/'),auth:{user:this.user,pass:this.key}});};Job.prototype.del=function(){return utils.makeRequest({method:'DELETE',url:['https://saucelabs.com/rest/v1',this.user,'jobs',this.id].join('/'),auth:{user:this.user,pass:this.key}});};module.exports=Job;